
<html>
<head>
	<title>GLGE Water Demo</title>

<!--	<script type="text/javascript" src="../Graphics/Frameworks/GLGE/glge-compiled-min.js"></script> -->
<script type="text/javascript" src="../Graphics/Frameworks/GLGE/glge-compiled.js"></script>


</head>
<body>

<canvas id="canvas" width="900" height="400"></canvas>
<script id="glge_document" type="text/xml">

<glge>


<material id="spaceMat">
	<texture id="spaceTex" src="space.jpg" />
	<material_layer texture="#spaceTex" mapinput="UV1" mapto="M_COLOR" />
</material>

<mesh id="unitMesh">
	<positions> </positions>
	<normals></normals>;
	<uv1></uv1>
	<faces></faces>
</mesh>

<mesh id="itemMesh">
	<positions> 
         1,  1, 0, 
         1, -1, 0,
        -1, -1, 0,
         0,  0, 1
          </positions>
	<normals>
        0,0, 0,
        0,1, 0,
        1,0, 0,
        1,1,1
        
    </normals>;
	<uv1>
        0,0,
        0,1,
        1,0,
        1,1
    </uv1>
	<faces>
    0, 1, 2,
    0, 1, 3,
    0, 2, 3,
    1, 2, 3    
    </faces>
</mesh>

<mesh id="buildingMesh">
	<positions>
    0,0,0,
    0,1,0,
    1,1,0,
    1,0,0,
    0,0,1,
    0,1,1,
    1,1,1,
    1,0,1
    </positions>
	<normals>
    -1,-1,-1,
    -1, 1,-1,
     1, 1,-1,
     1,-1,-1,
    -1,-1, 1,
    -1, 1, 1,
     1, 1, 1,
     1,-1, 1
    </normals>;
	<uv1>
    -1,-1,
    -1, 1,
     1, 1,
     1,-1,
    -1,-1,
    -1, 1,
     1, 1,
     1,-1
    </uv1>
	<faces>
    0,1,2,
    0,2,3,
    
    4,5,6,
    4,6,7,
    
    0,1,5,
    1,5,4,
    
    1,2,6,
    1,6,5,
    
    2,3,7,
    2,7,6,
    0,3,7,
    0,7,4
    </faces>
</mesh>

<mesh id="grassMesh">
	<positions>
    0, 0, 0,
    0, 1, 0,
    1, 1, 0,
    1, 0, 0
    </positions>
	<normals>
    -1, -1, 0,
    -1,  1, 0,
     1,  1, 0,
     1, -1, 0
    </normals>;
	<uv1>
    0, 0,
    0, 1,
    1, 1,
    1, 0
    </uv1>
	<faces>
    0, 1, 2,
    0, 2, 3
    </faces>
</mesh>


<mesh id="waterMesh">
	<positions>
    0, 0, 0,
    0, 1, 0,
    1, 1, 0,
    1, 0, 0
    </positions>
	<normals>
    -1, -1, 0,
    -1,  1, 0,
     1,  1, 0,
     1, -1, 0
    </normals>;
	<uv1>
    0, 0,
    0, 1,
    1, 1,
    1, 0
    </uv1>
	<faces>
    0, 1, 2,
    0, 2, 3
    </faces>
</mesh>

<material id="green" specular="1" shininess="20" color="green" />

<scene id="mainscene" ambient_color="#fff" camera="#mainCamera" background_color="#338">		
	<camera id="mainCamera" loc_x="4" loc_z="0" loc_y="-1.0" fov_y="35"/>



    <object id="item" mesh="#itemMesh" loc_x="0" loc_y="0" loc_z="0" material="#green" />


<!--
		<light id="mainlight" loc_y="5" type="L_POINT" /> 


    <light id="light1" loc_x="-3" loc_y="15" loc_z="-7" attenuation_quadratic="0.00001" attenuation_linear="0.00000001" attenuation_constant="1" type="L_POINT" />
	-->
    	
			<light id="light2" loc_x="3" loc_y="105" loc_z="7" attenuation_quadratic="0.00001" attenuation_linear="0.00000001" attenuation_constant="1.5" type="L_POINT" />

			


</scene>
</glge>

</script>

<script>


function createSquare()
    {
     var mesh = new GLGE.Mesh() ;
     
     var positions = Array() ;
     var normals   = Array() ;
     var uvs       = Array() ;
     var faces     = Array() ;
     
     positions.push( -0.5 ) ;
     positions.push( -0.5 ) ;
     positions.push(  0 ) ;

     normals.push( 0 ) ; normals.push( 0 ) ; normals.push( 1 ) ;

     uvs.push( 0 ) ; uvs.push( 0 ) ;


     positions.push( -0.5 ) ;
     positions.push(  0.5 ) ;
     positions.push(  0 ) ;

     normals.push( 0 ) ; normals.push( 0 ) ; normals.push( 1 ) ;

     uvs.push( 0 ) ; uvs.push( 1 ) ;

    
     positions.push(  0.5 ) ;
     positions.push(  0.5 ) ;
     positions.push(  0 ) ;

     normals.push( 0 ) ; normals.push( 0 ) ; normals.push( 1 ) ;

     uvs.push( 1 ) ; uvs.push( 1 ) ;


     positions.push(  0.5 ) ;
     positions.push( -0.5 ) ;
     positions.push(  0 ) ;

     normals.push( 0 ) ; normals.push( 0 ) ; normals.push( 1 ) ;

     uvs.push( 1 ) ; uvs.push( 0 ) ;


     mesh.setPositions( positions ) ;
     mesh.setNormals( normals ) ;
     mesh.setUV( uvs ) ;
     
    
     faces.push( 0 ) ; faces.push( 1 ) ; faces.push( 2 ) ;
     faces.push( 0 ) ; faces.push( 2 ) ; faces.push( 3 ) ;
    
     mesh.setFaces( faces ) ;
    
     return mesh ;
    } 
    
    
    

function createSphere( heightDivisions, pieSlices, invertNormals )
    {
     var normalDirection = 1 ;
    
     if( invertNormals == undefined ) 
        {
         invertNormals = false ;
        }
        
        
     if( invertNormals ) normalDirection *= -1 ;
    
    
     var mesh = new GLGE.Mesh() ;
    
     var x ;
     var y ;
     var z ;
     
     var radius ;
     
     var pointCount = 0 ;
     
     var points = Array() ;
     var uv = Array() ;

     var j = 0 ;
         
     for( var i = 0 ; i <= Math.PI ; i += Math.PI / heightDivisions )
        {
         z      = Math.cos( i ) ;
         radius = Math.sin( i ) ;
        
         for( var pieSlice = 0 ; pieSlice < pieSlices + 1 ; pieSlice++ )
            {
             j = 2 * Math.PI * pieSlice  / pieSlices ;
            
             x = radius * Math.cos( j ) ;
             y = radius * Math.sin( j ) ;
             
             uv.push( j / ( 2 * Math.PI ) ) ;
             uv.push( ( 1 - z ) / 2 ) ;
             
                                       
             points.push( x / 2 ) ;
             points.push( y / 2 ) ;
             points.push( z / 2 ) ;
             
             pointCount++ ;
            }
        
        }
   
      
     mesh.setPositions(  points ) ;
     mesh.setUV( uv ) ;

     
     normals = Array() ;
     
     for( var q in points )
     {
        normals.push( normalDirection * ( points[ q ] * 2 ) ) ;
     }
     
     
     
     
     mesh.setNormals( normals ) ;
     
     
     var faces= Array() ;
   
        
     var m ;
     
     
        
             
    for( var l = 0 ; l < heightDivisions ; l += 1 )
       {
   
   
         var low  =   l       * ( pieSlices + 1 )     ;
         var high = ( l + 1 ) * ( pieSlices + 1 )    ;
        
         for( m = 0 ; m < pieSlices  ; m++ )
            {
             var lowLeft    = low + m           ;
             var lowRight   = low + m + 1       ;
             
             var highLeft    = high + m         ;
             var highRight   = high + m + 1     ;
            
             faces.push( lowLeft  ) ;
             faces.push( lowRight ) ;
             faces.push( highLeft ) ;
             
             faces.push( highLeft  ) ;
             faces.push( highRight ) ;
             faces.push( lowRight  ) ;            
            }
        /*
         faces.push( low ) ;
         faces.push( high ) ;
         faces.push( high + pieSlices - 1 ) ;
         
         faces.push( low  + pieSlices - 1 ) ;
         faces.push( low  ) ;
         faces.push( high + pieSlices - 1 ) ;
        */
        }
    
                   
               
    mesh.setFaces( faces ) ;
     
     //     alert( mesh.faces.data ) ;


     return mesh ;
    }




var canvas = document.getElementById( 'canvas' )
var renderer = new GLGE.Renderer( canvas );

var XMLdoc = new GLGE.Document();

XMLdoc.onLoad = function(){
	var scene = XMLdoc.getElement( "mainscene" );
	renderer.setScene( scene );
	renderer.render();
    
	// var item = XMLdoc.getElement( "item" );
    // var building = XMLdoc.getElement( "building" );
    // var grass = XMLdoc.getElement( "grass" );
    // var water = XMLdoc.getElement( "water" );


    
    var spaceTexture = new GLGE.Texture( "space" ) ;
    
    spaceTexture.setSrc( "space.jpg" ) ;
    
    var materialLayer = new GLGE.MaterialLayer() ;
    materialLayer.setTexture( spaceTexture ) ;
    
 //   materialLayer.setMapinput( GLGE.UV1 ) ;
 //   materialLayer.setMapto( GLGE.M_COLOR ) ;
    
    var mat = new GLGE.Material() ;
    mat.addTexture( spaceTexture ) ;

    mat.addMaterialLayer( materialLayer ) ;

    mat.setAmbient( "#ffffff" ) ;
   // mat.setSpecular( "#ffffff" ) ;
    mat.setColor( "#ffffff" ) ;
    mat.setEmit( .2 ) ;

    var sphereMesh = createSphere( 20, 20, 1 ) ;
        
    var sphereMaterial = new GLGE.Material() ;
    
    var sphereObject = new GLGE.Object() ;


    var sphereMesh2 = createSphere( 10, 10 ) ;
    
    
    sphereMaterial.setColor( "#FF0000" ) ;
    sphereMaterial.setSpecular( 1 ) ;
    sphereMaterial.setShininess( 1 ) ;
    
     sphereObject.setMesh(       sphereMesh      ) ;
    sphereObject.setMaterial(   mat  ) ;
        

    sphereObject.setLoc( 0, 0, 0 ) ;
    
    
       var tile = createSquare() ;
    
    var grassTexture = new GLGE.Texture( "grass" ) ;
    
    grassTexture.setSrc( "grass.jpg" ) ;
    
    var grassLayer = new GLGE.MaterialLayer() ;
    grassLayer.setTexture( grassTexture ) ;
    
    
    var grassMaterial = new GLGE.Material() ;
    grassMaterial.addTexture( grassTexture ) ;

    grassMaterial.addMaterialLayer( grassLayer ) ;

    grassMaterial.setAmbient( "#ffffff" ) ;
   // mat.setSpecular( "#ffffff" ) ;
    grassMaterial.setColor( "#ffffff" ) ;
    grassMaterial.setEmit( .1 ) ;
    
    
        grassMaterial.setColor( "#000000" ) ;
    grassMaterial.setSpecular( 1 ) ;
    grassMaterial.setShininess( 1 ) ;
    
        var tileObject = new GLGE.Object() ;

    
     tileObject.setMesh(       tile      ) ;
    tileObject.setMaterial(   grassMaterial  ) ;
    
    tileObject.setRotX( Math.PI / 2 ) ;
        

    tileObject.setLoc( 0, -10, 0 ) ;
    

     tileObject.setScale( 10 ) ;
     
     
     var mat3 = new GLGE.Material() ;
     
     mat3.setColor( "#aaaaff" ) ;
     
     mat3.setAlpha( 0.7 ) ;
     
     var mouse=new GLGE.MouseInput(document.getElementById('canvas'));
     var keys=new GLGE.KeyInput();     
     
     var unit = new GLGE.Object() ;
     
     unit.setMaterial( mat3 ) ;
     unit.setMesh( createSphere( 15, 15 ) ) ;

    unit.setLoc( 0, 0, -10 ) ;
    
    var group = new GLGE.Group() ;
    
   // group.addChild( tileObject ) ;
    group.addChild( sphereObject ) ;
    
    scene.addChild( unit ) ;
    
    unit.pickingLabel = "asdf" ;
    
    sphereObject.setScale( 100 ) ;
    
    group.setRotX( Math.PI / 2 ) ;
    
     
    // sphereObject.setDrawType( GLGE.DRAW_POINTS ) ;
   //  sphereObject.setPointSize( 3 ) ;
    
     scene.addChild( group ) ;

    
	var camera = XMLdoc.getElement( "mainCamera" );

	canvas.onmousedown = function( e ){
		this.drag = { x:e.clientX, y:e.clientY, initRotY: group.getRotY(), initRot: group.getRotMatrix() };
	}
	canvas.onmousemove = function( e ){
		if ( this.drag ){
			var drag = this.drag;
			var offsetX = e.clientX - drag.x;
			var offsetY = e.clientY - drag.y;
            
			group.setRotMatrix(
				GLGE.mulMat4(
					drag.initRot,
					GLGE.mulMat4(
						GLGE.angleAxis(offsetY/100,[drag.initRot[0],drag.initRot[1],drag.initRot[2]]),
						GLGE.angleAxis(offsetX/100,[drag.initRot[4],drag.initRot[5],drag.initRot[6]])
					)
				)
			);
            
            /*
            building.setRotMatrix(
				GLGE.mulMat4(
					drag.initRot,
					GLGE.mulMat4(
						GLGE.angleAxis(offsetY/100,[drag.initRot[0],drag.initRot[1],drag.initRot[2]]),
						GLGE.angleAxis(offsetX/100,[drag.initRot[4],drag.initRot[5],drag.initRot[6]])
					)
				)
			);
            */
		}
	}
	canvas.onmouseup = function( e ){
		this.drag = null;
	}
	canvas.onmousewheel = function( e ){
		delta=e.wheelDelta/120;
		if(delta!=0){
			camera.setFovY(parseFloat(camera.getFovY())-delta);
		}
	}
	
	setInterval(function(){renderer.render()},15);
    
    
    document.getElementById("canvas").onmousedown=function(e)
        { 
         var obj = scene.pick(e.clientX-this.parentNode.offsetLeft,e.clientY-this.parentNode.offsetTop); 
        
         if( obj != null && obj.object.pickingLabel != undefined )
            alert( obj.object.pickingLabel ) ;
            
        
        }
    document.getElementById("canvas").onmouseover=function(e){mouseovercanvas=true;}
    document.getElementById("canvas").onmousemove=function(e){mouseovercanvas=true;}
    document.getElementById("canvas").onmouseout=function(e){mouseovercanvas=false;}

}

XMLdoc.parseScript("glge_document");

</script>



</body>
</html>